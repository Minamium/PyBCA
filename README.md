# PyBCA
Brownian Cellular Automaton for Python

## Installation
```bash
git clone https://github.com/Minamium/PyBCA.git
pip install -e ./PyBCA
```

# 開発方針メモ

2次元のブラウン回路の動作をシミュレートするセルオートマトン. 状態は3状態で表す.


### cudaBCA
既存のセル空間と遷移規則を保存したyamlよりセル空間と遷移規則を読み込み, cuda上でシミュレーションを行うクラス.

特殊イベントとして, 任意セルの状態により任意セルを任意の状態に変更するイベントを定義できる機能も持つ.

また重要な機能として, 任意に新しい遷移規則を追加してC-JoinやCrossのエラーレートを表現できるようしなければならない.

### CellSpaceEditor
セル空間を編集するGUIアプリケーション. セル空間を表示し, 任意のセルを任意の状態に変更することができる.
またセル空間の更新の様子を確認するため, 任意ステップ数の更新後のセル空間の表示や, 1ステップ毎の更新を見れるよう, 連続更新も可能.

また, 範囲指定のコピーアンドペースト, Redo/Undo, セル空間の保存とロードを行う.

## セル空間の更新操作の検討

### セル空間 1 ステップ更新の実装仕様（CUDA/並列安全）

目的：**GPU（CUDA）上でセル並列**のまま、**ランダム性の公平性**と**トークン（状態=2）の増殖禁止**を同時に満たす 1 ステップ更新を定義する。  
状態は **4値**：`0 = Vacant`, `1 = Wire(信号線)`, `2 = Token`, `-1 = ReCycleBinとの接続点`。

ReCycleBinとは、理想的にトークンが十分に存在する領域であり、その接続点はトークンが出てきたり、また入っていく(回路上からは消える)動作を示す.
---

#### 入出力・前提

- **入力テンソル** `State`：セル空間 `[Trial, H, W]`（既定）。`dtype=uint8` 推奨（1セル=1B）。  
  - `Trial` は独立試行の本数（多数並列）。  
- **乱数**：**stateless**（例：Philox/SplitMix64）で `(seed, step, trial, y, x, salt)` から決定的生成。  
- **境界**：既定 **periodic**（トーラス）。回路設計上、境界依存は本質ではない。  
- **グローバル適用確率** `p_global ∈ [0,1]`。  
- **ルール種別**（YAML/JSON からコンパイル）  
  - `Move1` … **1トークン → 1セル** の移動。  
  - `Move2 (C-Join)` … **2トークン → 2セル同時** の移動（直交ペア等）。  
  - `prev/next` は **von Neumann（C/E/W/N/S）** で記述。回転対称はロード時に展開。

**不変条件（この仕様で常に成立）**
- **1 宛先 = 高々 1 採択**（競合解決済）  
- **1 出発元 = 高々 1 提案**（分裂禁止）  
- `Move2` は **2 宛先とも同一 move_id で同時採択**された時のみ成立（片落ち禁止）  
- よって **トークン総数は保存**（外生イベントを除く）

---

### 更新アルゴリズム
THW, ruleテンソルによりTHW_boolMaskにマッチした3*3領域の中心座標を1へ(GPUでセル, trial並列)

THW_boolMaskの1のセルに対して独立に乱数スコアを与え、グローバル確率ゲートにより受容か棄却を判定、棄却ならTHW_boolMaskの該当要素を0に(GPUでセル, trial並列)
さらに遷移規則確率ゲートを遷移規則別確率よりかけて受容か棄却を判定、棄却ならTHW_boolMaskの該当要素を0に(GPUでセル, trial並列)

規則内競合解決
THW_boolMaskより中心座標から3*3拡大したtmp_maskを作成して規則内で3*3領域がかぶっているTHW_boolMaskの1の要素については両方とも0にする(GPUでセル, trial並列)

他規則競合解決
これまでの遷移規則により書き換えられたセルについて1を立てるフラグ情報配列[Trial, H, W]であるTHW_apllyed(bool)とtmp_maskがかぶるTHW_boolMaskの1の要素を0にする(GPUでセル, trial並列)

書き換え実行
THW_boolMaskとruleのnextを使ってnew_THWを書き換える。同時にTHW_apllyedの書き換えた差分セルの要素に対応する座標を0から1へ(GPUでセル, trial並列)